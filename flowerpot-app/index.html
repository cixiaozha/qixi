<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¿«æ¥ç§èŠ±å§</title>

<style>
body{background:#fff5f7;font-family:system-ui;margin:0;}
.app{max-width:420px;margin:40px auto;padding:25px;background:white;border-radius:20px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.12);}

.flowerpot-container{position:relative;width:220px;height:260px;margin:80px auto 0;}
.pot{position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:200px;}
.flower{position:absolute;bottom:55px;left:50%;transform:translateX(-50%) translateY(30px);width:130px;opacity:0;transition:0.8s;}
.flower.show{opacity:1;transform:translateX(-50%) translateY(0);}

.controls{margin-top:15px;display:flex;flex-direction:column;gap:10px;}
input{padding:10px;border-radius:10px;border:1px solid #ccc;}
button{padding:12px;border-radius:14px;border:none;background:#ff8fab;color:white;cursor:pointer;}

.popup{position:fixed;top:12%;left:50%;transform:translateX(-50%);background:#ffe0eb;padding:14px 22px;border-radius:16px;font-weight:bold;color:#c44569;display:none;}

.calendar-container{margin-top:20px;background:#fff6fa;border-radius:14px;padding:12px;}
.month-selector{display:flex;justify-content:space-between;align-items:center;margin:10px 0;padding:0 10px;}
.month-selector button{background:#ffb3c6;padding:8px 16px;font-size:14px;border:none;border-radius:20px;color:white;cursor:pointer;}
.month-selector button:active{transform:scale(0.95);}
#monthTitle{font-size:18px;font-weight:bold;color:#c44569;}

#calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px;}
.weekday{font-size:12px;color:#c44569;font-weight:500;padding:4px 0;}
.day{padding:8px 0;border-radius:8px;font-size:13px;cursor:pointer;background:#eee;color:#aaa;}
.day.watered{background:#222;color:#fff;}
.day.event{background:#ffd700;color:#000;}
.day.today{outline:2px solid #ff8fab;}

.day-detail{margin-top:16px;background:#fff0f5;border-radius:14px;padding:12px;text-align:left;}
</style>
</head>

<body>

<div class="app">
<h2>ğŸŒ± 520å¤©ç›†æ ½æƒŠå–œ</h2>
<p id="dayText">å·²æµ‡æ°´å¤©æ•°ï¼š--</p>

<div class="flowerpot-container">
<img src="./images/pot.png" class="pot" alt="pot">
<img src="./images/flower1.png" class="flower" id="flowerImg" alt="flower">
</div>

<div class="controls">
<input id="messageInput" placeholder="å†™ç‚¹ä»Šå¤©çš„è¯ï¼ˆé€‰å¡«ï¼‰">
<button id="waterBtn">ğŸ’§ ä»Šæ—¥æµ‡æ°´</button>
</div>

<div class="calendar-container">
<h3>ğŸ“… æœˆå† Â· 2026</h3>
<div class="month-selector">
<button id="prevMonthBtn">â—€</button>
<span id="monthTitle">2026å¹´1æœˆ</span>
<button id="nextMonthBtn">â–¶</button>
</div>
<div id="calendar"></div>
</div>

<div class="day-detail">
<h3>ğŸ“œ å½“å¤©è®°å½•</h3>
<div id="detailContent">ç‚¹å‡»æ—¥å†æŸ¥çœ‹æŸä¸€å¤© ğŸŒ±</div>
</div>

</div>

<div id="popup" class="popup"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
// Firebaseé…ç½®
const firebaseConfig={
apiKey:"AIzaSyDc27UjdsySJAz4-1NpY0Cgs3Jq3402o70",
authDomain:"flowerpotapp-d0c7a.firebaseapp.com",
databaseURL:"https://flowerpotapp-d0c7a-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"flowerpotapp-d0c7a"
};

firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const potRef=db.ref("flowerPot");

const dayText=document.getElementById("dayText");
const flowerImg=document.getElementById("flowerImg");
const waterBtn=document.getElementById("waterBtn");
const messageInput=document.getElementById("messageInput");
const popup=document.getElementById("popup");
const calendar=document.getElementById("calendar");
const detail=document.getElementById("detailContent");
const monthTitle=document.getElementById("monthTitle");
const prevBtn=document.getElementById("prevMonthBtn");
const nextBtn=document.getElementById("nextMonthBtn");

// è·å–åŒ—äº¬æ—¶é—´æ—¥æœŸçš„å‡½æ•°ï¼ˆè§£å†³å‡Œæ™¨è®°å½•é—®é¢˜ï¼‰
function getBeijingDateKey() {
  const now = new Date();
  // è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰
  const beijingTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
  const year = beijingTime.getUTCFullYear();
  const month = String(beijingTime.getUTCMonth() + 1).padStart(2, '0');
  const day = String(beijingTime.getUTCDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// å½“å‰æ˜¾ç¤ºçš„æœˆä»½ï¼ˆé»˜è®¤2026å¹´1æœˆï¼‰
let currentYear=2026;
let currentMonth=0; // 0 = ä¸€æœˆ

function showPopup(text){
popup.textContent=text;
popup.style.display="block";
setTimeout(()=>popup.style.display="none",3000);
}

function showDayDetail(dateStr,data){
const msgs=data.messages?.[dateStr]||[];
const evs=data.specialEvents?.[dateStr]||[];

let html=`<b>ğŸ“… ${dateStr}</b><br>`;
if(!msgs.length&&!evs.length) html+=`<span style="opacity:0.6">è¿™ä¸€å¤©æ²¡æœ‰è®°å½• ğŸŒ±</span>`;
msgs.forEach(m=>html+=`ğŸ’¬ ${m}<br>`);
evs.forEach(e=>html+=`<span style="color:#8e44ad">âœ¨ ${e}</span><br>`);
detail.innerHTML=html;
}

function renderMonth(year,month,data){
// æ›´æ–°æ ‡é¢˜
monthTitle.textContent=`${year}å¹´${month+1}æœˆ`;

// è·å–å½“æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
const firstDay=new Date(year,month,1);
const lastDay=new Date(year,month+1,0);
const daysInMonth=lastDay.getDate();

// å½“æœˆ1å·æ˜¯æ˜ŸæœŸå‡ ï¼ˆ0=æ˜ŸæœŸæ—¥ï¼Œä½†æˆ‘ä»¬éœ€è¦æ˜ŸæœŸä¸€å¼€å¤´ï¼Œæ‰€ä»¥è°ƒæ•´ï¼‰
let startWeekday=firstDay.getDay(); // 0å‘¨æ—¥ 1å‘¨ä¸€ ... 6å‘¨å…­
// è½¬æˆä»¥å‘¨ä¸€ä¸ºç¬¬ä¸€å¤©ï¼šå‘¨æ—¥=6ï¼Œå‘¨ä¸€=0ï¼Œå‘¨äºŒ=1 ...
const mondayStart=(startWeekday===0)?6:startWeekday-1;

// ç”Ÿæˆæ˜ŸæœŸæ ‡é¢˜ï¼ˆå‘¨ä¸€åˆ°å‘¨æ—¥ï¼‰
const weekdays=['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'];
calendar.innerHTML=weekdays.map(w=>`<div class="weekday">${w}</div>`).join('');

// å¡«å……ç©ºç™½æ ¼å­
for(let i=0;i<mondayStart;i++){
const empty=document.createElement("div");
empty.className="day";
empty.style.background="transparent";
empty.style.cursor="default";
calendar.appendChild(empty);
}

// å¡«å……æ—¥æœŸ
const today=new Date();
for(let d=1;d<=daysInMonth;d++){
const dateStr=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
const div=document.createElement("div");
div.className="day";
div.textContent=d;

// æ ¹æ®æ•°æ®æ·»åŠ æ ·å¼
if(data.messages?.[dateStr]) div.classList.add("watered");
if(data.specialEvents?.[dateStr]) div.classList.add("event");

// åˆ¤æ–­æ˜¯å¦æ˜¯ä»Šå¤©ï¼ˆä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼‰
const beijingNow = new Date(new Date().getTime() + (8 * 60 * 60 * 1000));
if(year===beijingNow.getUTCFullYear() && month===beijingNow.getUTCMonth() && d===beijingNow.getUTCDate()){
div.classList.add("today");
}

// ç‚¹å‡»äº‹ä»¶
div.onclick=()=>showDayDetail(dateStr,data);
calendar.appendChild(div);
}

// è¡¥å…¨æœ€åä¸€è¡Œç©ºç™½
const totalCells=mondayStart+daysInMonth;
const remainder=totalCells%7;
if(remainder!==0){
for(let i=0;i<7-remainder;i++){
const empty=document.createElement("div");
empty.className="day";
empty.style.background="transparent";
empty.style.cursor="default";
calendar.appendChild(empty);
}
}
}

async function loadPot(){
let snap=await potRef.get();
let data=snap.exists()?snap.val():{currentDay:0,lastWatered:0,messages:{},specialEvents:{},matured:false};
// ç¡®ä¿æ•°æ®ç»“æ„å®Œæ•´
if(!data.messages) data.messages={};
if(!data.specialEvents) data.specialEvents={};
await potRef.set(data); // ä¿å­˜é»˜è®¤ç»“æ„

dayText.textContent=`å·²æµ‡æ°´å¤©æ•°ï¼š${data.currentDay}`;

const stage=Math.min(Math.floor(data.currentDay/40)+1,13);
flowerImg.src=`./images/flower${stage}.png`;
flowerImg.classList.remove("show");
setTimeout(()=>flowerImg.classList.add("show"),50);

// æ¸²æŸ“å½“å‰æœˆä»½
renderMonth(currentYear,currentMonth,data);

// å½“å¤©ç¥ç§˜äº‹ä»¶å¼¹çª—ï¼ˆä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼‰
const todayKey=getBeijingDateKey();
if(data.specialEvents?.[todayKey]?.length){
showPopup(`âœ¨ ç¥ç§˜åŠ›é‡ï¼š${data.specialEvents[todayKey].slice(-1)[0]}`);
}

// æˆç†Ÿæç¤ºï¼ˆ520å¤©ï¼‰
if(data.currentDay>=520 && !data.matured){
showPopup("ğŸ èŠ±å·²æˆç†Ÿ");
await potRef.set({...data,matured:true});
}
}

waterBtn.onclick=async()=>{
let snap=await potRef.get();
let data=snap.val();

const today=new Date().toDateString();
const last=new Date(data.lastWatered).toDateString();
if(today===last){alert("ä»Šå¤©æµ‡è¿‡äº†");return;}

const msg=messageInput.value.trim();
// ä½¿ç”¨åŒ—äº¬æ—¶é—´ä½œä¸ºè®°å½•key
const todayKey=getBeijingDateKey();
const messages=data.messages||{};
if(msg){
if(!messages[todayKey]) messages[todayKey]=[];
messages[todayKey].push(msg);
}

await potRef.set({
...data,
currentDay:data.currentDay+1,
lastWatered:Date.now(),
messages:messages
});

messageInput.value="";
loadPot(); // åˆ·æ–°æ‰€æœ‰è§†å›¾
};

// æœˆä»½åˆ‡æ¢é€»è¾‘
prevBtn.onclick=()=>{
currentMonth--;
if(currentMonth<0){
currentMonth=11;
currentYear--;
}
loadPot(); // é‡æ–°è·å–æ•°æ®å¹¶åˆ·æ–°æœˆå†
};

nextBtn.onclick=()=>{
currentMonth++;
if(currentMonth>11){
currentMonth=0;
currentYear++;
}
loadPot();
};

// å¯åŠ¨
loadPot();
</script>
</body>
</html>
