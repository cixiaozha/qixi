<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>520å¤©ç›†æ ½</title>

<style>
body{background:#fff5f7;font-family:system-ui;margin:0;}
.app{max-width:420px;margin:40px auto;padding:25px;background:white;border-radius:20px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.12);}

.flowerpot-container{position:relative;width:220px;height:260px;margin:80px auto 0;}
.pot{position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:200px;}
.flower{position:absolute;bottom:55px;left:50%;transform:translateX(-50%) translateY(30px);width:130px;opacity:0;transition:0.8s;}
.flower.show{opacity:1;transform:translateX(-50%) translateY(0);}

.controls{margin-top:15px;display:flex;flex-direction:column;gap:10px;}
input{padding:10px;border-radius:10px;border:1px solid #ccc;}
button{padding:12px;border-radius:14px;border:none;background:#ff8fab;color:white;cursor:pointer;}

.popup{position:fixed;top:12%;left:50%;transform:translateX(-50%);background:#ffe0eb;padding:14px 22px;border-radius:16px;font-weight:bold;color:#c44569;display:none;}

.calendar-container{margin-top:20px;background:#fff6fa;border-radius:14px;padding:12px;}
#calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px;}
.day{padding:6px 0;border-radius:8px;font-size:11px;cursor:pointer;}
.gray{background:#eee;color:#aaa;}
.watered{background:#222;color:#fff;}
.event{background:#ffd700;color:#000;}
.today{outline:2px solid #ff8fab;}

.day-detail{margin-top:16px;background:#fff0f5;border-radius:14px;padding:12px;text-align:left;}
</style>
</head>

<body>

<div class="app">
<h2>ğŸŒ± 520å¤©ç›†æ ½</h2>
<p id="dayText">å·²æµ‡æ°´å¤©æ•°ï¼š--</p>

<div class="flowerpot-container">
<img src="./images/pot.png" class="pot">
<img src="./images/flower1.png" class="flower" id="flowerImg">
</div>

<div class="controls">
<input id="messageInput" placeholder="å†™ç‚¹ä»Šå¤©çš„è¯ï¼ˆé€‰å¡«ï¼‰">
<button id="waterBtn">ğŸ’§ ä»Šæ—¥æµ‡æ°´</button>
</div>

<div class="calendar-container">
<h3>ğŸ“… æ—¶é—´æ—¥å†</h3>
<div id="calendar"></div>
</div>

<div class="day-detail">
<h3>ğŸ“œ å½“å¤©è®°å½•</h3>
<div id="detailContent">ç‚¹å‡»æ—¥å†æŸ¥çœ‹æŸä¸€å¤© ğŸŒ±</div>
</div>

</div>

<div id="popup" class="popup"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig={
apiKey:"AIzaSy...",
authDomain:"flowerpotapp-d0c7a.firebaseapp.com",
databaseURL:"https://flowerpotapp-d0c7a-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"flowerpotapp-d0c7a"
};

firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const potRef=db.ref("flowerPot");

const dayText=document.getElementById("dayText");
const flowerImg=document.getElementById("flowerImg");
const waterBtn=document.getElementById("waterBtn");
const messageInput=document.getElementById("messageInput");
const popup=document.getElementById("popup");
const calendar=document.getElementById("calendar");
const detail=document.getElementById("detailContent");

function showPopup(text){
popup.textContent=text;
popup.style.display="block";
setTimeout(()=>popup.style.display="none",3000);
}

function showDayDetail(dateStr,data){
const msgs=data.messages?.[dateStr]||[];
const evs=data.specialEvents?.[dateStr]||[];

let html=`<b>ğŸ“… ${dateStr}</b><br>`;
if(!msgs.length&&!evs.length) html+=`<span style="opacity:0.6">è¿™ä¸€å¤©æ²¡æœ‰è®°å½• ğŸŒ±</span>`;
msgs.forEach(m=>html+=`ğŸ’¬ ${m}<br>`);
evs.forEach(e=>html+=`<span style="color:#8e44ad">âœ¨ ${e}</span><br>`);
detail.innerHTML=html;
}

function renderCalendar(data){
calendar.innerHTML="";
const start=new Date("2026-01-28");
const today=new Date();
const watered=new Set(Object.keys(data.messages||{}));
const events=new Set(Object.keys(data.specialEvents||{}));
const totalDays=Math.floor((today-start)/(86400000))+1;

for(let i=0;i<totalDays;i++){
const d=new Date(start);
d.setDate(start.getDate()+i);
const dateStr=d.toISOString().split("T")[0];

const div=document.createElement("div");
div.className="day gray";
div.textContent=`${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}`;

if(watered.has(dateStr))div.className="day watered";
if(events.has(dateStr))div.className="day event";
if(dateStr===today.toISOString().split("T")[0])div.classList.add("today");

div.onclick=()=>showDayDetail(dateStr,data);
calendar.appendChild(div);
}
}

async function loadPot(){
let snap=await potRef.get();
let data=snap.exists()?snap.val():{currentDay:0,lastWatered:0,messages:{},specialEvents:{},matured:false};
await potRef.set(data);

dayText.textContent=`å·²æµ‡æ°´å¤©æ•°ï¼š${data.currentDay}`;

const stage=Math.min(Math.floor(data.currentDay/40)+1,13);
flowerImg.src=`./images/flower${stage}.png`;
flowerImg.classList.remove("show");
setTimeout(()=>flowerImg.classList.add("show"),50);

renderCalendar(data);

/* å½“å¤©ç¥ç§˜äº‹ä»¶å¼¹çª— */
const todayKey=new Date().toISOString().split("T")[0];
if(data.specialEvents?.[todayKey]?.length){
showPopup(`âœ¨ ç¥ç§˜åŠ›é‡ï¼š${data.specialEvents[todayKey].slice(-1)[0]}`);
}

/* æˆç†Ÿ */
if(data.currentDay>=520&&!data.matured){
showPopup("ğŸ èŠ±å·²æˆç†Ÿ");
await potRef.set({...data,matured:true});
}
}

waterBtn.onclick=async()=>{
let snap=await potRef.get();
let data=snap.val();

const today=new Date().toDateString();
const last=new Date(data.lastWatered).toDateString();
if(today===last){alert("ä»Šå¤©æµ‡è¿‡äº†");return;}

const msg=messageInput.value.trim();
const todayKey=new Date().toISOString().split("T")[0];
const messages=data.messages||{};
if(msg){messages[todayKey]=messages[todayKey]||[];messages[todayKey].push(msg);}

await potRef.set({...data,currentDay:data.currentDay+1,lastWatered:Date.now(),messages});
messageInput.value="";
loadPot();
};

loadPot();
</script>
</body>
</html>
