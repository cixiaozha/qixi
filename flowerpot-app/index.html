<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿«æ¥ç§èŠ±å§</title>
  <link rel="stylesheet" href="./style.css">
  <style>
    /* è¦†ç›–éƒ¨åˆ†æ ·å¼ä¿è¯åŠ¨ç”»å’Œä½ç½® */
    .flower {
      position: absolute;
      bottom: 55px;
      left: 50%;
      transform: translateX(-50%) translateY(30px);
      width: 130px;
      z-index: 2;
      opacity: 0;
      transition: opacity 0.8s ease, transform 0.8s ease;
    }
    .flower.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .popup {
      position: fixed;
      top: 12%;
      left: 50%;
      transform: translateX(-50%);
      background: #ffe0eb;
      padding: 14px 22px;
      border-radius: 16px;
      font-weight: bold;
      color: #c44569;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      display: none;
      z-index: 999;
    }
  </style>
</head>
<body>

  <div class="app">
    <h1>ğŸŒ± 520å¤©ç›†æ ½æƒŠå–œ</h1>

    <p id="dayText">å·²æµ‡æ°´å¤©æ•°ï¼š--</p>

    <!-- èŠ±ç›†åŒºåŸŸ -->
    <div class="flowerpot-container">
      <img src="./images/pot.png" class="pot" alt="èŠ±ç›†">
      <img src="./images/flower1.png" class="flower" id="flowerImg" alt="èŠ±">
    </div>

    <!-- æ“ä½œåŒº -->
    <div class="controls">
      <input id="messageInput" placeholder="æè¿°ä»Šå¤©çš„å¿ƒæƒ…æˆ–å‘ç”Ÿçš„äº‹æƒ…å§~ï¼ˆé€‰å¡«ï¼‰">
      <button id="waterBtn">ğŸ’§ ä»Šæ—¥æµ‡æ°´</button>
    </div>
  </div>

  <!-- å¼¹å¹• -->
  <div id="popup" class="popup"></div>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyDc27UjdsySJAz4-1NpY0Cgs3Jq3402o70",
      authDomain: "flowerpotapp-d0c7a.firebaseapp.com",
      databaseURL: "https://flowerpotapp-d0c7a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "flowerpotapp-d0c7a",
      storageBucket: "flowerpotapp-d0c7a.firebasestorage.app",
      messagingSenderId: "347864027088",
      appId: "1:347864027088:web:ee3a267fb4f546bb5ef3d5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const potRef = db.ref("flowerPot");

    const dayText = document.getElementById("dayText");
    const flowerImg = document.getElementById("flowerImg");
    const waterBtn = document.getElementById("waterBtn");
    const messageInput = document.getElementById("messageInput");
    const popup = document.getElementById("popup");

    const titles = [
      "æœ€ä½³æµ‡æ°´å‘˜ ğŸŒ¸","èŠ±å›­å®ˆæŠ¤è€… ğŸŒ¿","è‡ªç„¶ä¹‹å‹ ğŸƒ","æ˜¥å¤©ä½¿è€… ğŸŒ·","èŠ±å›­å¤§å¸ˆ ğŸŒ¹","çˆ±å¿ƒå›­ä¸ ğŸ’–",
      "ç»ˆæèŠ±ç¥ ğŸŒŸ","æ—¶é—´çš„æœ‹å‹ â³","å‘½è¿ä¿®å‰ªè€… âœ‚ï¸","ä¸–ç•Œçº¿å®ˆæŠ¤äºº ğŸŒŒ","èŠ±å¼€å³æ°¸æ’ ğŸ’«","ç»ˆç« ä¹‹èŠ± ğŸ‘‘","æˆç†Ÿç¤¼ç‰©æ‹¥æœ‰è€… ğŸ"
    ];

    function showPopup(text){
      popup.textContent = text;
      popup.style.display = "block";
      popup.classList.add("popup-animate");
      setTimeout(()=>{
        popup.style.display="none";
        popup.classList.remove("popup-animate");
      },3200);
    }

    async function loadPot(){
      const snap = await potRef.get();
      let data = snap.exists()? snap.val() : null;
      if(!data){
        data = {currentDay:0,lastWatered:0,messages:{},specialEvents:{},matured:false};
        await potRef.set(data);
      }

      dayText.textContent = `å·²æµ‡æ°´å¤©æ•°ï¼š${data.currentDay ?? 0}`;

      // è®¡ç®—æˆé•¿é˜¶æ®µ
      const stage = Math.min(Math.floor((data.currentDay ?? 0)/40)+1,13);
      flowerImg.src = `./images/flower${stage}.png`;
      flowerImg.classList.remove("show");
      setTimeout(()=>{ flowerImg.classList.add("show"); },50);

      // æ¯ 40 å¤©æ˜¾ç¤ºç§°å·å¼¹å¹•
      if(data.currentDay >0 && data.currentDay %40 ===0){
        const index = Math.min(Math.floor(data.currentDay/40)-1, titles.length-1);
        showPopup(`è·å¾—ç§°å·ï¼š${titles[index]} âœ¨`);
      }

      // æ˜¾ç¤ºå‰ä¸€å¤©ç¥ç§˜åŠ›é‡
      const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
      const yKey = yesterday.toISOString().split("T")[0];
      const events = data.specialEvents?.[yKey] ?? [];
      if(events.length>0){ showPopup(`âœ¨ ç¥ç§˜åŠ›é‡ï¼š${events[events.length-1]}`); }

      // æˆç†Ÿæç¤º
      if((data.currentDay ??0)>=520 && !data.matured){
        showPopup("ğŸ èŠ±å·²æˆç†Ÿï¼Œå‘½è¿è¢«å½»åº•æ”¹å†™");
        await potRef.set({...data,matured:true});
      }
    }

    waterBtn.onclick=async()=>{
      const snap = await potRef.get();
      const data = snap.exists()? snap.val() : {currentDay:0,lastWatered:0,messages:{},specialEvents:{},matured:false};
      const todayStr = new Date().toDateString();
      const lastStr = new Date(data.lastWatered ?? 0).toDateString();
      if(todayStr===lastStr){alert("ä»Šå¤©å·²ç»æµ‡è¿‡æ°´å•¦ ğŸ’§"); return;}

      const msg = messageInput.value.trim();
      const messages = data.messages ?? {};
      const todayKey = new Date().toISOString().split("T")[0];
      if(msg){ messages[todayKey] = messages[todayKey] ?? []; messages[todayKey].push(msg); }

      await potRef.set({...data, currentDay:(data.currentDay??0)+1, lastWatered:Date.now(), messages});
      messageInput.value="";
      loadPot();
    }

    loadPot();
  </script>
</body>
</html>
