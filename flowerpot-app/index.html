<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿«æ¥ç§èŠ±å§</title>
  <style>
    body {
      background: #fff5f7;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
    }
    .app {
      max-width: 420px;
      margin: 40px auto;
      padding: 30px 20px;
      background: white;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }
    h1 {
      margin-bottom: 15px;
    }
    .flowerpot-container {
      position: relative;
      width: 220px;
      height: 260px;
      margin: 80px auto;
    }
    .pot {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 200px;
      z-index: 1;
      margin-bottom: -60px;
    }
    .flower {
      position: absolute;
      bottom: 55px;
      left: 50%;
      transform: translateX(-50%);
      width: 130px;
      z-index: 2;
      opacity: 0;
      transition: all 0.8s ease;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }
    input {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      padding: 12px;
      border-radius: 14px;
      border: none;
      background: #ff8fab;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    button:active {
      transform: scale(0.97);
    }
    .popup {
      position: fixed;
      top: 12%;
      left: 50%;
      transform: translateX(-50%);
      background: #ffe0eb;
      padding: 14px 22px;
      border-radius: 16px;
      font-weight: bold;
      color: #c44569;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      display: none;
      z-index: 999;
    }
    .popup-animate {
      animation: popupFade 0.8s ease;
    }
    @keyframes popupFade {
      0% { transform: translateY(30px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>ğŸŒ± 520å¤©ç›†æ ½æƒŠå–œ</h1>
    <p id="dayText">å·²æµ‡æ°´å¤©æ•°ï¼š--</p>
    <div class="flowerpot-container">
      <img src="./images/pot.png" class="pot" alt="èŠ±ç›†">
      <img src="./images/flower1.png" class="flower" id="flowerImg" alt="èŠ±">
    </div>
    <div class="controls">
      <input id="messageInput" placeholder="æè¿°ä»Šå¤©çš„å¿ƒæƒ…æˆ–å‘ç”Ÿçš„äº‹æƒ…å§~ï¼ˆé€‰å¡«ï¼‰">
      <button id="waterBtn">ğŸ’§ ä»Šæ—¥æµ‡æ°´</button>
    </div>
  </div>
  <div id="popup" class="popup"></div>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDc27UjdsySJAz4-1NpY0Cgs3Jq3402o70",
      authDomain: "flowerpotapp-d0c7a.firebaseapp.com",
      databaseURL: "https://flowerpotapp-d0c7a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "flowerpotapp-d0c7a",
      storageBucket: "flowerpotapp-d0c7a.firebasestorage.app",
      messagingSenderId: "347864027088",
      appId: "1:347864027088:web:ee3a267fb4f546bb5ef3d5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const potRef = db.ref("flowerPot");

    const dayText = document.getElementById("dayText");
    const flowerImg = document.getElementById("flowerImg");
    const waterBtn = document.getElementById("waterBtn");
    const messageInput = document.getElementById("messageInput");
    const popup = document.getElementById("popup");

    const titles = [
      "æœ€ä½³æµ‡æ°´å‘˜ ğŸŒ¸","èŠ±å›­å®ˆæŠ¤è€… ğŸŒ¿","è‡ªç„¶ä¹‹å‹ ğŸƒ","æ˜¥å¤©ä½¿è€… ğŸŒ·","èŠ±å›­å¤§å¸ˆ ğŸŒ¹","çˆ±å¿ƒå›­ä¸ ğŸ’–",
      "ç»ˆæèŠ±ç¥ ğŸŒŸ","æ—¶é—´çš„æœ‹å‹ â³","å‘½è¿ä¿®å‰ªè€… âœ‚ï¸","ä¸–ç•Œçº¿å®ˆæŠ¤äºº ğŸŒŒ","èŠ±å¼€å³æ°¸æ’ ğŸ’«","ç»ˆç« ä¹‹èŠ± ğŸ‘‘","æˆç†Ÿç¤¼ç‰©æ‹¥æœ‰è€… ğŸ"
    ];

    function showPopup(text){
      popup.textContent = text;
      popup.style.display = "block";
      popup.classList.add("popup-animate");
      setTimeout(()=>{
        popup.style.display="none";
        popup.classList.remove("popup-animate");
      },3200);
    }

    async function loadPot(){
      const snap = await potRef.get();
      let data = snap.exists() ? snap.val() : null;

      if(!data){
        data = {currentDay:0,lastWatered:0,messages:{},specialEvents:{},matured:false};
        await potRef.set(data);
      }

      dayText.textContent = `å·²æµ‡æ°´å¤©æ•°ï¼š${data.currentDay ?? 0}`;

      const stage = Math.min(Math.floor((data.currentDay ?? 0)/40)+1,13);
      flowerImg.src = `./images/flower${stage}.png`;
      flowerImg.style.opacity = 0;
      flowerImg.style.transform = "translateY(30px)";
      setTimeout(()=>{
        flowerImg.style.opacity=1;
        flowerImg.style.transform="translateY(0)";
      },50);

      if(data.currentDay>0 && data.currentDay%40===0){
        const index = Math.min(Math.floor(data.currentDay/40)-1,titles.length-1);
        showPopup(`è·å¾—ç§°å·ï¼š${titles[index]} âœ¨`);
      }

      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate()-1);
      const yKey = yesterday.toISOString().split("T")[0];
      const events = data.specialEvents?.[yKey] ?? [];
      if(events.length>0){
        showPopup(`âœ¨ ç¥ç§˜åŠ›é‡ï¼š${events[events.length-1]}`);
      }

      if((data.currentDay ?? 0) >=520 && !data.matured){
        showPopup("ğŸ èŠ±å·²æˆç†Ÿï¼Œå‘½è¿è¢«å½»åº•æ”¹å†™");
        await potRef.set({...data,matured:true});
      }
    }

    waterBtn.onclick=async()=>{
      const snap=await potRef.get();
      const data=snap.exists()?snap.val():{currentDay:0,lastWatered:0,messages:{},specialEvents:{},matured:false};
      const todayStr = new Date().toDateString();
      const lastStr = new Date(data.lastWatered ?? 0).toDateString();
      if(todayStr===lastStr){alert("ä»Šå¤©å·²ç»æµ‡è¿‡æ°´å•¦ ğŸ’§"); return;}
      const msg = messageInput.value.trim();
      const messages = data.messages ?? {};
      const todayKey = new Date().toISOString().split("T")[0];
      if(msg){messages[todayKey] = messages[todayKey] ?? []; messages[todayKey].push(msg);}
      await potRef.set({...data,currentDay:(data.currentDay??0)+1,lastWatered:Date.now(),messages});
      messageInput.value="";
      loadPot();
    }

    loadPot();
  </script>
</body>
</html>
