<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å†°å†°ç‰Œæµæ˜Ÿç­¾</title>
<style>
  html, body {
    margin: 0;
    height: 100%;
    overflow: hidden;
    font-family: 'Microsoft YaHei', sans-serif;
    background: radial-gradient(ellipse at top, #0b0c2c 0%, #1b1f4d 100%);
  }
  #canvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 1;
  }
  #instructions {
    position: absolute;
    top: 20px;
    width: 100%;
    text-align: center;
    font-size: 18px;
    color: #fffacd;
    text-shadow: 0 0 10px #000;
    z-index: 2;
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0% { opacity: 0.7; }
    50% { opacity: 1; }
    100% { opacity: 0.7; }
  }
  
  /* è¿›åº¦æŒ‡ç¤ºå™¨ */
  #progress {
    position: absolute;
    top: 60px;
    width: 100%;
    text-align: center;
    color: #88f;
    font-size: 16px;
    z-index: 2;
  }
  
  /* ç‚¹å‡»æç¤º */
  #clickHint {
    position: absolute;
    bottom: 120px;
    width: 100%;
    text-align: center;
    color: rgba(255, 255, 255, 0.6);
    font-size: 14px;
    z-index: 2;
    animation: float 3s ease-in-out infinite;
  }
  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  #fortuneContainer {
    position: absolute;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%);
    display: none;
    z-index: 2;
  }
  .fortune-card {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    padding: 25px 35px;
    border-radius: 15px;
    font-size: 20px;
    text-align: center;
    color: #fff;
    text-shadow: 0 0 5px #000;
    box-shadow: 0 0 20px #88f;
    animation: glow 2s infinite alternate;
    position: relative;
    overflow: hidden;
    max-width: 500px;
    min-width: 300px;
  }
  @keyframes glow {
    from { box-shadow: 0 0 10px #88f; }
    to { box-shadow: 0 0 20px #88f, 0 0 30px #88f; }
  }
  .fortune-card::before {
    content: '';
    position: absolute;
    top: -10px;
    left: -10px;
    right: -10px;
    bottom: -10px;
    background: linear-gradient(45deg, #ff00cc, #3333ff, #00ccff, #33ff99);
    z-index: -1;
    filter: blur(20px);
    opacity: 0.5;
    animation: rotate 10s linear infinite;
  }
  @keyframes rotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* è¿åŠ¿ç±»å‹æŒ‡ç¤ºå™¨ */
  .fortune-type {
    position: absolute;
    top: -10px;
    right: 15px;
    padding: 3px 10px;
    border-radius: 10px;
    font-size: 12px;
    background: rgba(255,255,255,0.3);
  }
  
  #storyBtn {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    border: none;
    padding: 15px 35px;
    border-radius: 25px;
    font-size: 18px;
    color: #fff;
    cursor: pointer;
    transition: all 0.3s;
    z-index: 2;
  }
  #storyBtn:hover {
    background: rgba(255,255,255,0.4);
    transform: translateX(-50%) scale(1.05);
  }
  
  /* é‡ç½®æŒ‰é’® */
  #resetBtn {
    position: absolute;
    bottom: 20px;
    left: 20px;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    border: none;
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 14px;
    color: #fff;
    cursor: pointer;
    transition: all 0.3s;
    z-index: 2;
    display: none;
  }
  #resetBtn:hover {
    background: rgba(255,255,255,0.4);
  }
  
  .constellation-name {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 24px;
    opacity: 0;
    transition: opacity 1s;
    text-shadow: 0 0 10px #88f;
    z-index: 2;
  }
  
  /* éŸ³æ•ˆæ§åˆ¶ */
  #soundToggle {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    border: none;
    padding: 8px 12px;
    border-radius: 20px;
    color: #fff;
    cursor: pointer;
    z-index: 2;
  }
  
  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    #instructions { font-size: 16px; }
    .fortune-card { font-size: 18px; padding: 20px 25px; }
    #storyBtn, #resetBtn { padding: 12px 20px; font-size: 16px; }
  }
</style>
</head>
<body>
<div id="instructions">ç‚¹å‡»å¤©ç©ºï¼Œç‚¹äº® 5 é¢—æ˜Ÿï¼Œå¾—åˆ°ä½ çš„ä»Šæ—¥è¿åŠ¿</div>
<div id="progress">å·²ç‚¹äº®: 0/5</div>
<div id="clickHint">âœ¨ ç‚¹å‡»ä»»æ„ä½ç½®æ”¾ç½®æ˜Ÿæ˜Ÿ âœ¨</div>
<canvas id="canvas"></canvas>
<div id="fortuneContainer">
  <div class="fortune-card" id="fortuneBox"></div>
</div>
<button id="resetBtn">é‡æ–°è®¸æ„¿</button>
<button id="storyBtn">è¿›å…¥æ•…äº‹å†Œ</button>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let stars = [];
let maxStars = 5;
let particles = [];
let backgroundStars = [];
let constellationGlow = { active: false, radius: 0, alpha: 0 };
let sparkles = [];
let soundEnabled = true;

// æ˜Ÿåº§åç§°
const constellationNames = [
  "å¸Œæœ›ä¹‹æ˜Ÿ", "å¹¸è¿ä¹‹ç¯", "æ™ºæ…§ä¹‹çœ¼", "å‹‡æ°”ä¹‹ç›¾", "å’Œè°ä¹‹èˆ",
  "æ¢¦æƒ³ä¹‹ç¿¼", "å®é™ä¹‹å¿ƒ", "ç¹è£ä¹‹æ ‘", "å‹è°Šä¹‹æ¡¥", "çœŸçˆ±ä¹‹ç»“"
];

const fortunes = [
  {text: "ä»Šå¤©ä½ ä¼šé‡åˆ°å°æƒŠå–œ~", type: "lucky", emoji: "ğŸ"},
  {text: "å¿ƒæƒ…ä¼šç‰¹åˆ«å¥½ï¼Œç¬‘å®¹æ»¡æ»¡", type: "happy", emoji: "ğŸ˜Š"},
  {text: "è¿æ°”ä¸é”™ï¼Œè¯•è¯•æ–°çš„æŒ‘æˆ˜", type: "lucky", emoji: "ğŸ€"},
  {text: "å»æ‰¾å†°å†°ç©", type: "lucky", emoji: "ğŸ‘¤"},
  {text: "å·¥ä½œå­¦ä¹ éƒ½é¡ºåˆ©", type: "success", emoji: "ğŸ“š"},
  {text: "é‡åˆ°å¥½åƒçš„ç¾é£Ÿ", type: "happy", emoji: "ğŸœ"},
  {text: "å¿ƒæƒ³äº‹æˆçš„ä¸€å¤©", type: "lucky", emoji: "â­"},
  {text: "é€‚åˆå‡ºè¡Œ", type: "travel", emoji: "âœˆï¸"},
  {text: "æœ‰äººæ¬£èµä½ çš„åŠªåŠ›", type: "success", emoji: "ğŸ‘"},
  {text: "è´¢è¿ä¸é”™ï¼Œé’±åŒ…è½»æ¾", type: "lucky", emoji: "ğŸ’°"},
  {text: "å¿ƒæƒ…è½»æ¾æ„‰å¿«", type: "happy", emoji: "ğŸŒ"},
  {text: "å®¹æ˜“å¾—åˆ°ç§°èµ", type: "success", emoji: "ğŸ†"},
  {text: "æœ‰æ„å¤–æ”¶è·", type: "lucky", emoji: "ğŸ¯"},
  {text: "ä»Šå¤©é€‚åˆå°è¯•æ–°äº‹ç‰©", type: "success", emoji: "ğŸ†•"},
  {text: "ç²¾ç¥çŠ¶æ€æä½³", type: "happy", emoji: "ğŸ’ª"},
  {text: "é€‚åˆåˆ›ä½œå’ŒåŠ¨æ‰‹", type: "success", emoji: "ğŸ¨"},
  {text: "è´¢åŠ¡çŠ¶å†µå¹³ç¨³", type: "success", emoji: "ğŸ’³"},
  {text: "å¥½å¿ƒæƒ…æŒç»­ä¸€æ•´å¤©", type: "happy", emoji: "ğŸŒˆ"},
  {text: "å°æ„¿æœ›å®ç°", type: "lucky", emoji: "âœ¨"},
  {text: "ä»Šå¤©é€‚åˆæ•´ç†è®¡åˆ’", type: "success", emoji: "ğŸ“"},
  {text: "æœ‰æœºä¼šè·å¾—è®¤å¯", type: "success", emoji: "ğŸ–ï¸"},
  {text: "æ¸¸ç©å¿ƒæƒ…æ„‰å¿«", type: "travel", emoji: "ğŸš—"},
  {text: "å­¦ä¹ æ•ˆç‡é«˜", type: "success", emoji: "ğŸ“–"},
  {text: "äººé™…é¡ºåˆ©", type: "happy", emoji: "ğŸ¤"},
  {text: "è¢«å¤¸å¥–çš„æœºä¼šå¤š", type: "success", emoji: "ğŸŒŸ"},
  {text: "é€‚åˆè¡¨è¾¾è‡ªå·±", type: "success", emoji: "ğŸ¤"},
  {text: "å°æƒŠå–œè¿è¿", type: "lucky", emoji: "ğŸ‰"},
  {text: "å°è¯•æ–°æŠ€èƒ½é¡ºåˆ©", type: "success", emoji: "ğŸ› ï¸"},
  {text: "å¥åº·çŠ¶å†µè‰¯å¥½", type: "happy", emoji: "â¤ï¸"},
  {text: "å¿ƒæ€ç§¯æ", type: "happy", emoji: "ğŸ˜‡"},
  {text: "å·¥ä½œè¿›å±•é¡ºåˆ©", type: "success", emoji: "ğŸ’¼"},
  {text: "å®¹æ˜“è¢«äººç†è§£", type: "happy", emoji: "ğŸ’•"},
  {text: "ç”Ÿæ´»å°ç¡®å¹¸", type: "lucky", emoji: "ğŸŒ¼"},
  {text: "çµæ„Ÿé¢‘ç¹å‡ºç°", type: "success", emoji: "ğŸ’¡"},
  {text: "å°å¿ƒå®¹æ˜“é—å¿˜é‡è¦äº‹æƒ…", type: "warning", emoji: "âš ï¸"},
  {text: "æ³¨æ„èº«ä½“ç–²åŠ³", type: "warning", emoji: "ğŸ˜´"},
  {text: "æœ‰ç‚¹å°æ³¢æŠ˜ï¼Œä¸è¦ç€æ€¥", type: "warning", emoji: "ğŸŒ€"},
  {text: "å°è¯¯ä¼šå¯èƒ½å‘ç”Ÿ", type: "warning", emoji: "ğŸ’¬"},
  {text: "è´¢åŠ¡å°æŸå¤±", type: "warning", emoji: "ğŸ’°"},
  {text: "æƒ…ç»ªå®¹æ˜“æ³¢åŠ¨", type: "warning", emoji: "ğŸŒŠ"},
  {text: "å®¹æ˜“é”™è¿‡æœºä¼š", type: "warning", emoji: "â°"},
  {text: "äº‰æ‰§å°æ‘©æ“¦", type: "warning", emoji: "âš¡"},
  {text: "å®¹æ˜“æ‹–å»¶", type: "warning", emoji: "ğŸŒ"},
  {text: "éœ€è¦å¤šæ³¨æ„å®‰å…¨", type: "warning", emoji: "ğŸ”"},
  {text: "æ²Ÿé€šéœ€è¦è€å¿ƒ", type: "warning", emoji: "ğŸ—£ï¸"},
  {text: "å°å¿ƒç‰©å“ä¸¢å¤±", type: "warning", emoji: "ğŸ”"},
  {text: "æ³¨æ„é¥®é£Ÿå¥åº·", type: "warning", emoji: "ğŸ"},
  {text: "è®¡åˆ’å¯èƒ½æœ‰å˜", type: "warning", emoji: "ğŸ“…"},
  {text: "éœ€è¦æ›´å¤šä¼‘æ¯", type: "warning", emoji: "ğŸ›Œ"},
  {text: "é¿å…å†²åŠ¨æ¶ˆè´¹", type: "warning", emoji: "ğŸ›’"},
  {text: "å°å¿ƒäº¤é€šå»¶è¯¯", type: "warning", emoji: "ğŸš¦"},
  {text: "æ³¨æ„æ—¶é—´ç®¡ç†", type: "warning", emoji: "â³"},
  {text: "é¿å…è¿‡åº¦æ‰¿è¯º", type: "warning", emoji: "ğŸ¤"},
  {text: "æ£€æŸ¥é‡è¦æ–‡ä»¶", type: "warning", emoji: "ğŸ“„"},
  // æ–°å¢çš„å¥½è¿ç­¾
  {text: "è´µäººç›¸åŠ©ï¼Œäº‹åŠåŠŸå€", type: "lucky", emoji: "ğŸ™"},
  {text: "åˆ›æ„æ— é™ï¼Œçµæ„Ÿè¿¸å‘", type: "success", emoji: "ğŸ­"},
  {text: "å›¢é˜Ÿåˆä½œé»˜å¥‘", type: "success", emoji: "ğŸ‘¥"},
  {text: "æ¡ƒèŠ±è¿æ—ºç››", type: "lucky", emoji: "ğŸŒ¸"},
  {text: "å­¦ä¹ æ–°çŸ¥è¯†å¾ˆå¿«", type: "success", emoji: "ğŸ§ "},
  {text: "è§£å†³é—®é¢˜èƒ½åŠ›å¼º", type: "success", emoji: "ğŸ”§"},
  {text: "èº«ä½“å¥åº·æ´»åŠ›è¶³", type: "happy", emoji: "ğŸƒ"},
  {text: "äººé™…å…³ç³»å’Œè°", type: "happy", emoji: "ğŸ’"},
  {text: "äº‹ä¸šæœ‰æ–°çªç ´", type: "success", emoji: "ğŸš€"},
  {text: "æ—…è¡Œæ”¶è·æ»¡æ»¡", type: "travel", emoji: "ğŸ’"},
  {text: "è‰ºæœ¯å¤©èµ‹å±•ç°", type: "success", emoji: "ğŸ¶"},
  {text: "è´¢è¿äº¨é€š", type: "lucky", emoji: "ğŸ’"},
  {text: "å†…å¿ƒå¹³é™å®‰å®", type: "happy", emoji: "ğŸ§˜"},
  {text: "æœºä¼šä¸»åŠ¨æ‰¾ä¸Šé—¨", type: "lucky", emoji: "ğŸšª"},
  {text: "è¡¨è¾¾æ¸…æ™°æœ‰è¯´æœåŠ›", type: "success", emoji: "ğŸ¯"},
  {text: "è¿åŠ¨è¡¨ç°ä¼˜å¼‚", type: "success", emoji: "âš½"},
  {text: "ç¾é£Ÿè¿è¶…å¥½", type: "happy", emoji: "ğŸ£"},
  {text: "ç¡çœ è´¨é‡å¾ˆé«˜", type: "happy", emoji: "ğŸŒ™"},
  // æ–°å¢çš„æ¸©é¦¨æç¤º
  {text: "å°å¿ƒè¨€è¯­è¯¯ä¼š", type: "warning", emoji: "ğŸ”‡"},
  {text: "é¿å…è¿‡åº¦åŠ³ç´¯", type: "warning", emoji: "ğŸ˜«"},
  {text: "æ³¨æ„å¤©æ°”å˜åŒ–", type: "warning", emoji: "ğŸŒ§ï¸"},
  {text: "é‡è¦çº¦ä¼šæå‰ç¡®è®¤", type: "warning", emoji: "ğŸ“"},
  {text: "æ£€æŸ¥éšèº«ç‰©å“", type: "warning", emoji: "ğŸ’"},
  {text: "é¿å…é‡è¦å†³å®š", type: "warning", emoji: "ğŸ¤”"},
  {text: "æ³¨æ„é¥®é£Ÿå«ç”Ÿ", type: "warning", emoji: "ğŸ½ï¸"},
  {text: "å°å¿ƒç½‘ç»œè¯ˆéª—", type: "warning", emoji: "ğŸ•¸ï¸"},
  {text: "é‡è¦æ–‡ä»¶å¤‡ä»½", type: "warning", emoji: "ğŸ’¾"}
];

// èƒŒæ™¯æ˜Ÿæ˜Ÿç±»
class BackgroundStar {
  constructor() {
    this.x = Math.random() * canvas.width;
    this.y = Math.random() * canvas.height;
    this.size = Math.random() * 2 + 0.5;
    this.brightness = Math.random() * 0.8 + 0.2;
    this.twinkleSpeed = Math.random() * 0.02 + 0.005;
    this.twinkleOffset = Math.random() * Math.PI * 2;
  }
  
  update() {
    // é—ªçƒæ•ˆæœ
    this.brightness = 0.5 + Math.sin(Date.now() * this.twinkleSpeed + this.twinkleOffset) * 0.3;
  }
  
  draw() {
    ctx.save();
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(255, 255, 255, ${this.brightness})`;
    ctx.fill();
    ctx.restore();
  }
}

// ç²’å­ç±»
class Particle {
  constructor(x, y) {
    this.x = x;
    this.y = y;
    this.size = Math.random() * 3 + 1;
    this.speedX = Math.random() * 2 - 1;
    this.speedY = Math.random() * 2 - 1;
    this.color = `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.5})`;
    this.life = 30;
  }
  
  update() {
    this.x += this.speedX;
    this.y += this.speedY;
    this.life--;
  }
  
  draw() {
    ctx.save();
    ctx.fillStyle = this.color;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }
}

class Sparkle {
  constructor(x, y) {
    this.x = x;
    this.y = y;
    this.size = Math.random() * 4 + 2;
    this.speedX = (Math.random() - 0.5) * 2;
    this.speedY = (Math.random() - 0.5) * 2;
    this.life = 50;
    this.maxLife = 50;
  }
  
  update() {
    this.x += this.speedX;
    this.y += this.speedY;
    this.life--;
  }
  
  draw() {
    const progress = this.life / this.maxLife;
    ctx.save();
    ctx.globalAlpha = progress;
    ctx.fillStyle = '#ffffff';
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size * progress, 0, Math.PI * 2);
    ctx.fill();
    
    // æ·»åŠ å…‰èŠ’æ•ˆæœ
    for (let i = 0; i < 4; i++) {
      ctx.beginPath();
      ctx.moveTo(this.x, this.y);
      ctx.lineTo(
        this.x + Math.cos(i * Math.PI / 2) * this.size * 2 * progress,
        this.y + Math.sin(i * Math.PI / 2) * this.size * 2 * progress
      );
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 1;
      ctx.stroke();
    }
    
    ctx.restore();
  }
}

class Star {
  constructor(x,y){
    this.x = x;
    this.y = y;
    this.radius = 0;
    this.targetRadius = 6;
    this.brightness = 0;
    this.pulse = 0;
    this.pulseDirection = 1;
    this.color = `hsl(${50 + Math.random() * 20}, 100%, 70%)`;
  }
  
  draw(){
    ctx.save();
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.radius + this.pulse, 0, Math.PI*2);
    ctx.fillStyle = `${this.color.replace(')', `, ${this.brightness})`)}`;
    ctx.shadowColor = this.color;
    ctx.shadowBlur = 15;
    ctx.fill();
    
    if (this.brightness > 0.5) {
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.radius * 2, 0, Math.PI*2);
      const gradient = ctx.createRadialGradient(
        this.x, this.y, this.radius,
        this.x, this.y, this.radius * 2
      );
      gradient.addColorStop(0, `${this.color.replace(')', `, ${this.brightness * 0.5})`)}`);
      gradient.addColorStop(1, `${this.color.replace(')', `, 0)`)}`);
      ctx.fillStyle = gradient;
      ctx.fill();
    }
    
    ctx.restore();
  }
  
  update(){
    if(this.radius < this.targetRadius) this.radius += 0.3;
    if(this.brightness < 1) this.brightness += 0.05;
    
    if (this.brightness > 0.8) {
      this.pulse += 0.05 * this.pulseDirection;
      if (this.pulse > 1 || this.pulse < 0) {
        this.pulseDirection *= -1;
      }
    }
    
    this.draw();
  }
}

// æ›´æ–°è¿›åº¦æ˜¾ç¤º
function updateProgress() {
  document.getElementById('progress').textContent = `å·²ç‚¹äº®: ${stars.length}/${maxStars}`;
}

function connectStars(){
  ctx.beginPath();
  
  // æ ¹æ®æ˜Ÿæ˜Ÿæ•°é‡æ”¹å˜è¿çº¿é¢œè‰²
  const hue = 200 + (stars.length / maxStars) * 40;
  ctx.strokeStyle = `hsla(${hue}, 70%, 70%, 0.7)`;
  ctx.lineWidth = 2;
  ctx.shadowBlur = 10;
  ctx.shadowColor = `hsla(${hue}, 70%, 70%, 0.7)`;
  
  for(let i=0;i<stars.length-1;i++){
    ctx.moveTo(stars[i].x,stars[i].y);
    ctx.lineTo(stars[i+1].x,stars[i+1].y);
  }
  ctx.stroke();
  
  if (stars.length > 1) {
    for (let i = 0; i < stars.length - 1; i++) {
      const start = stars[i];
      const end = stars[i+1];
      
      if (Math.random() < 0.1) {
        const progress = Math.random();
        const x = start.x + (end.x - start.x) * progress;
        const y = start.y + (end.y - start.y) * progress;
        particles.push(new Particle(x, y));
      }
    }
  }
}

function highlightConstellation(){
  stars.forEach(s=>{
    s.brightness = 1;
    s.radius = s.targetRadius + 3;
  });
  
  constellationGlow.active = true;
  constellationGlow.radius = 0;
  constellationGlow.alpha = 0.5;
  
  stars.forEach(star => {
    for (let i = 0; i < 10; i++) {
      particles.push(new Particle(star.x, star.y));
      sparkles.push(new Sparkle(star.x, star.y));
    }
  });
  
  const nameElement = document.createElement('div');
  nameElement.className = 'constellation-name';
  nameElement.textContent = constellationNames[Math.floor(Math.random() * constellationNames.length)];
  document.body.appendChild(nameElement);
  
  setTimeout(() => {
    nameElement.style.opacity = 1;
  }, 500);
  
  setTimeout(() => {
    nameElement.style.opacity = 0;
    setTimeout(() => {
      document.body.removeChild(nameElement);
    }, 1000);
  }, 3000);
  
  // æ’­æ”¾å®ŒæˆéŸ³æ•ˆ
  if(soundEnabled) {
    // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…éŸ³æ•ˆ
    console.log("æ’­æ”¾æ˜Ÿåº§å®ŒæˆéŸ³æ•ˆ");
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  
  // ç»˜åˆ¶èƒŒæ™¯æ˜Ÿæ˜Ÿ
  backgroundStars.forEach(star => {
    star.update();
    star.draw();
  });
  
  if (constellationGlow.active) {
    ctx.save();
    ctx.beginPath();
    
    let centerX = 0, centerY = 0;
    stars.forEach(star => {
      centerX += star.x;
      centerY += star.y;
    });
    centerX /= stars.length;
    centerY /= stars.length;
    
    let maxDistance = 0;
    stars.forEach(star => {
      const distance = Math.sqrt(
        Math.pow(star.x - centerX, 2) + Math.pow(star.y - centerY, 2)
      );
      if (distance > maxDistance) maxDistance = distance;
    });
    
    const gradient = ctx.createRadialGradient(
      centerX, centerY, 0,
      centerX, centerY, maxDistance + constellationGlow.radius
    );
    gradient.addColorStop(0, `rgba(100, 150, 255, ${constellationGlow.alpha})`);
    gradient.addColorStop(1, 'rgba(100, 150, 255, 0)');
    
    ctx.fillStyle = gradient;
    ctx.arc(centerX, centerY, maxDistance + constellationGlow.radius, 0, Math.PI * 2);
    ctx.fill();
    
    constellationGlow.radius += 2;
    constellationGlow.alpha -= 0.02;
    
    if (constellationGlow.alpha <= 0) {
      constellationGlow.active = false;
    }
    
    ctx.restore();
  }
  
  stars.forEach(s=>s.update());
  if(stars.length>1) connectStars();
  
  particles.forEach((particle, index) => {
    particle.update();
    particle.draw();
    if (particle.life <= 0) {
      particles.splice(index, 1);
    }
  });
  
  sparkles.forEach((sparkle, index) => {
    sparkle.update();
    sparkle.draw();
    if (sparkle.life <= 0) {
      sparkles.splice(index, 1);
    }
  });
  
  requestAnimationFrame(draw);
}

canvas.addEventListener('click', e=>{
  if(stars.length >= maxStars) return;
  let star = new Star(e.clientX, e.clientY);
  stars.push(star);
  
  // æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ
  if(soundEnabled) {
    console.log("æ’­æ”¾æ˜Ÿæ˜Ÿç‚¹å‡»éŸ³æ•ˆ");
  }
  
  updateProgress();
  
  if(stars.length === maxStars){
    highlightConstellation();
    setTimeout(showFortune, 2000);
    document.getElementById('resetBtn').style.display = 'block';
    document.getElementById('clickHint').style.display = 'none';
  }
});

function showFortune(){
  const isGood = Math.random() < 0.8;
  const filtered = fortunes.filter(f => 
    isGood ? f.type !== "warning" : f.type === "warning"
  );
  const fortune = filtered[Math.floor(Math.random() * filtered.length)];
  const box = document.getElementById('fortuneBox');
  const container = document.getElementById('fortuneContainer');
  
  box.innerHTML = `${fortune.emoji} ${fortune.text}`;
  
  // æ·»åŠ è¿åŠ¿ç±»å‹æŒ‡ç¤º
  const typeIndicator = document.createElement('div');
  typeIndicator.className = 'fortune-type';
  typeIndicator.textContent = fortune.type === "warning" ? "æ¸©é¦¨æç¤º" : "å¥½è¿ç­¾";
  typeIndicator.style.background = fortune.type === "warning" ? 
    'rgba(255, 100, 100, 0.3)' : 'rgba(100, 255, 100, 0.3)';
  box.appendChild(typeIndicator);
  
  container.style.display = 'block';
  container.style.opacity = 0;
  container.style.transform = 'translateX(-50%) scale(0.8)';
  setTimeout(() => {
    container.style.transition = 'opacity 0.5s, transform 0.5s';
    container.style.opacity = 1;
    container.style.transform = 'translateX(-50%) scale(1)';
  }, 100);
}

// åˆå§‹åŒ–èƒŒæ™¯æ˜Ÿæ˜Ÿ
for (let i = 0; i < 200; i++) {
  backgroundStars.push(new BackgroundStar());
}

// é‡ç½®åŠŸèƒ½
document.getElementById('resetBtn').addEventListener('click', () => {
  stars = [];
  particles = [];
  sparkles = [];
  constellationGlow.active = false;
  document.getElementById('fortuneContainer').style.display = 'none';
  document.getElementById('resetBtn').style.display = 'none';
  document.getElementById('clickHint').style.display = 'block';
  updateProgress();
});

// éŸ³æ•ˆæ§åˆ¶
document.getElementById('soundToggle').addEventListener('click', () => {
  soundEnabled = !soundEnabled;
  document.getElementById('soundToggle').textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
});

document.getElementById('storyBtn').addEventListener('click',()=>{
  window.location.href = "story.html";
});

window.addEventListener('resize',()=>{
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});

draw();
</script>
</body>
</html>

